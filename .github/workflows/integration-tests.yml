name: Run Integration Tests & PII Detection

on:
  pull_request:
    branches: [ main ]
  push:
    branches: [ main ]

jobs:
  integration-test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set Up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: maven

      - name: Build and Run Integration Tests
        run: mvn clean test -Dtest=LoggingServiceIntegrationTest

      - name: Upload Logs (For PII Detection Later)
        uses: actions/upload-artifact@v4
        with:
          name: test-logs
          path: logstest/application-direct-log.txt

  pii-detection:
    needs: integration-test
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Download Logs from Previous Job
        uses: actions/download-artifact@v4
        with:
          name: test-logs
          path: logstest/

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install PII Detector
        run: |
          pip install git+https://github.com/isudarsan/PII_Detector.git  # Update with your actual repo URL

      - name: Run PII Detection on Logs
        id: pii_check
        run: |
          if pii-detector detect logstest/application-direct-log.txt; then
            echo "✅ No PII found in logs."
            echo "pii_found=false" >> $GITHUB_ENV
          else
            echo "⚠️ PII detected in logs!"
            echo "pii_found=true" >> $GITHUB_ENV
          fi

      - name: Anonymize Logs If PII Was Found
        if: env.pii_found == 'true'
        run: |
          echo "🔄 Anonymizing log file..."
          pii-detector anonymize logstest/application-direct-log.txt --output_file logstest/application-direct-log.txt
          echo "✅ Log file anonymized."

      - name: Upload Anonymized Log (After PII Detection)
        if: env.pii_found == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: anonymized-log
          path: logstest/application-direct-log.txt  # ✅ Uploads the anonymized log

      - name: Generate Summary with Download Link
        if: env.pii_found == 'true'
        run: |
          ARTIFACT_URL="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}/artifacts"
          echo "### ✅ Download Anonymized Log" >> $GITHUB_STEP_SUMMARY
          echo "🔗 [Click here to download the anonymized log file](${ARTIFACT_URL})" >> $GITHUB_STEP_SUMMARY
